---
title: "Etosha Heights Plot Vegetation Indices"
output: html_document
date: "2025-09-25"
---

```{r setup, include=FALSE, echo = F, message = F}
knitr::opts_chunk$set(echo = TRUE)
library(terra)
library(tidyverse)
```

```{r, echo = F, message = F}
# read in the stacks of vi data along with sample plot polygons
veg.p <- vect("L:/projects/etosha_heights/eh_veg_data/DB_EtoshaHeights_VegTransects_5m_buffer.shp")
eh.evi <- rast(list.files(path = "L:/projects/etosha_heights/eh_planet/evi/", pattern = glob2rx("*.tif"), full.names = T))
eh.savi <- rast(list.files(path = "L:/projects/etosha_heights/eh_planet/savi/", pattern = glob2rx("*.tif"), full.names = T))
eh.nirv <- rast(list.files(path = "L:/projects/etosha_heights/eh_planet/nirv/", pattern = glob2rx("*.tif"), full.names = T))
eh.ndvi <- rast(list.files(path = "L:/projects/etosha_heights/eh_planet/ndvi/", pattern = glob2rx("*.tif"), full.names = T))

# set layer names 
names(eh.evi) <- c(substr(list.files(path = "L:/projects/etosha_heights/eh_planet/evi/",pattern = glob2rx("*.tif")),1,11))
names(eh.savi) <- c(substr(list.files(path = "L:/projects/etosha_heights/eh_planet/savi/",pattern = glob2rx("*.tif")),1,11))
names(eh.nirv) <- c(substr(list.files(path = "L:/projects/etosha_heights/eh_planet/nirv/",pattern = glob2rx("*.tif")),1,11))
names(eh.ndvi) <- c(substr(list.files(path = "L:/projects/etosha_heights/eh_planet/ndvi/",pattern = glob2rx("*.tif")),1,11))

# not sure why this didn't carry through from the processing step...
veg.p <- project(veg.p, eh.evi)

# read plot-level mean vi values and associated field height data
plt.vi <- read.csv("L:/projects/etosha_heights/eh_vi_extracts/eh_plot_mean_vi.csv", header = T)


# create a factor for veg community
plt.vi$VegComm <- as.factor(plt.vi$assoc)

# create a factor for the larger groups
plt.vi$vg <- case_when(
  plt.vi$assoc %in% c(1:4) ~ "Mountain", 
  plt.vi$assoc %in% c(5:7) ~ "Wetland", 
  plt.vi$assoc > 7 ~ "Savanna Shrubland"
)

# aggregate by veg class
vcl <- plt.vi %>%
  group_by(VegComm,timestamp) %>%
  summarise(evi = mean(evi, na.rm = T),
            svi = mean(savi, na.rm = T),
            nrv = mean(nir, na.rm = T),
            ndvi = mean(ndvi, na.rm = T),
            elev = mean(elev, na.rm = T))

# can only plot with POSIXct class
vcl$ts <- as.POSIXct(vcl$timestamp)

# aggregate by veg group
vgr <- plt.vi %>%
  group_by(vg,timestamp) %>%
  summarise(evi = mean(evi, na.rm = T),
            svi = mean(savi, na.rm = T),
            nrv = mean(nir, na.rm = T),
            ndvi = mean(ndvi, na.rm = T),
            elev = mean(elev, na.rm = T))

# can only plot with POSIXct class
vgr$ts <- as.POSIXct(vgr$timestamp)

# add time stamp here
plt.vi$ts <-as.POSIXct(plt.vi$timestamp)
```


```{r, echo = F, message = F}

# read sitewide mean and standard deviation data and add coefficient of variation
eh.vi <- read.csv("L:/projects/etosha_heights/eh_vi_extracts/eh_site_vi.csv", header = T) %>%
         mutate(ndvi.cv = ndvi.sd/ndvi,
                 evi.cv = evi.sd/evi,
                 savi.cv = savi.sd/savi,
                 nirv.cv = nirv.sd/nirv)

eh.vi$timestamp <- as.POSIXct(strptime(as.numeric(substr(eh.vi$name,4,11)), 
                             format = "%Y%m%d"))

# make long data set for plotting
eh.cv <- eh.vi %>%
  select(name, timestamp, ends_with(".cv")) %>%
  pivot_longer(cols = ends_with(".cv"),
               names_to = "vi", values_to = "cv") %>%
  mutate(vi = gsub(".cv","",vi))
 

eh.sd <- eh.vi %>%
  select(name, timestamp, ends_with(".sd")) %>%
  pivot_longer(cols = ends_with(".sd"),
               names_to = "vi", values_to = "sd") %>%
  mutate(vi = gsub(".sd","",vi)) %>%
  full_join(eh.cv)

eh.vil <- eh.vi %>%
  select(name, timestamp, !contains(".")) %>%
  pivot_longer(cols = contains("v"),
               names_to = "vi", values_to = "mean") %>%
  full_join(eh.sd)

rm(eh.cv, eh.sd)


# plot-level metrics
sm.vi <- plt.vi %>%
         group_by(timestamp) %>%
         summarise(evi.sd = sd(evi, na.rm = T),
                savi.sd = sd(savi, na.rm = T),
                nir.sd = sd(nir, na.rm = T),
                ndvi.sd =sd(ndvi, na.rm = T),
                evi = mean(evi, na.rm = T),
                savi = mean(savi, na.rm = T),
                nir = mean(nir, na.rm = T),
                ndvi = mean(ndvi, na.rm = T)) %>%
          mutate(ndvi.cv = ndvi.sd/ndvi,
                 evi.cv = evi.sd/evi,
                 savi.cv = savi.sd/savi,
                 nir.cv = nir.sd/nir) %>%
          na.omit

sm.vi$timestamp <- as.POSIXct(sm.vi$timestamp)

#knitr::kable(tm.sd, caption = "Standard Deviation")

```


```{r, echo = F, message = F}
#------------------- MET data--------------------------------#
#------------------------------------------------------------#  
  # read temp and precip data
  prcp <- read.csv("L:/projects/etosha_heights/eh_met_data/daily_precip.csv", header = T)

eh.prcp <- prcp %>%
  group_by(tmstmp) %>%
  summarise(eh.precip = mean(precip.mm))

eh.prcp$tmstmp <- as.POSIXct(strptime(eh.prcp$tmstmp,
                                      format = "%Y-%m-%d"))

ta <- read.csv("L:/projects/etosha_heights/eh_met_data/daily_air_temp.csv", header = T)

eh.ta <- ta %>%
  group_by(tmstmp) %>%
  summarise(airTemp = mean(airTemp, na.rm = T))

eh.ta$tmstmp <- as.POSIXct(strptime(eh.ta$tmstmp,
                                    format = "%Y-%m-%d"))

#------------------------------------------------------------#
```



```{r, echo = F, message = F, warning = F}
#------------------- PLOTS ----------------------------------#
#------------------------------------------------------------#
#-------------------------------------------------------------
# theme for the plots
My_Theme = theme(
  axis.title = element_text(size = 16),
  axis.text = element_text(size = 14),
  legend.text = element_text(size = 10),
  legend.title = element_text(size = 10))

#-------------------met variables------------------------#    
# barplot of site precip
p <- ggplot(data = eh.prcp,
       aes(x = tmstmp, y = eh.precip)) +
        geom_bar(stat = "identity", position = "dodge") +
        xlim(c(min(eh.vi$timestamp), max(eh.vi$timestamp))) +
        labs(y = "Precip (mm)",
             x = NULL) +
        My_Theme

# line plot of temperature
t <- ggplot(data = eh.ta, aes(x= tmstmp, y = airTemp)) +
        geom_line() + 
        xlim(c(min(vcl$ts), max(vcl$ts))) +
        labs(y = "Air Temperature", 
             x = NULL) + 
        My_Theme

# plot coeffificient of variation for each vi
cvp <- ggplot() + 
  geom_line(data = eh.vil, aes(x = timestamp, y = cv, color = vi)) +
  geom_point(data = eh.vil, aes(x = timestamp, y = cv, color = vi)) + 
  labs(color = "Veg Index", 
    y = "Coefficient of Variation", 
    x = NULL) +
#  theme(legend.position = "none") + 
  My_Theme


cv.pr <- ggplot() + 
  geom_line(data = eh.vil, aes(x = timestamp, y = cv, color = vi)) +
  geom_point(data = eh.vil, aes(x = timestamp, y = cv, color = vi)) +
  geom_bar(data = eh.prcp,aes(x = tmstmp, y = eh.precip*0.009),
           stat = "identity", position = "dodge") +
  xlim(c(min(eh.vi$timestamp), max(eh.vi$timestamp))) +
    labs(x = NULL, color = NULL) +
  scale_y_continuous(name = "CV",
                     sec.axis = sec_axis(transform = ~./0.009, name = "Precipitation (mm)")) +
  My_Theme +
  theme(legend.position = c(0.2,0.9)) + 
  scale_color_discrete(labels = c("EVI", "NDVI", "NIRV", "SAVI")) +
  guides(color = guide_legend(nrow = 2)) 
  
 
vi.pr <- ggplot() + 
  geom_line(data = eh.vil, aes(x = timestamp, y = mean, color = vi)) +
  geom_point(data = eh.vil, aes(x = timestamp, y = mean, color = vi)) +
  geom_bar(data = eh.prcp,aes(x = tmstmp, y = eh.precip*0.009),
           stat = "identity", position = "dodge") +
  xlim(c(min(eh.vi$timestamp), max(eh.vi$timestamp))) +
    labs(x = NULL, color = NULL) +
  scale_y_continuous(name = "VI",
                     sec.axis = sec_axis(transform = ~./0.009, name = "Precipitation (mm)")) +
  My_Theme +
  theme(legend.position = c(0.2,0.9)) + 
  scale_color_discrete(labels = c("EVI", "NDVI", "NIRV", "SAVI")) +
  guides(color = guide_legend(nrow = 2)) 

#cv.pr  +vi.pr + theme(legend.position="none") +  plot_layout((ncol=1))


cv.pr
  
```


Figure 1. Coefficient of variation for different vegetation indices across Etosha Heights Reserve for the 2023-2024 wet season. Gray bars indicate daily precipitation sums, and correspond to the scale on the right axis. 



```{r pressure, echo=FALSE, warning = F}
vi.pr
```


Figure 2. Seasonal timeseries of four vegetation indices across the Etosha Heights Reserve for the 2023-2024 wet season. Gray bars indicate daily precipitation sums, and correspond to the scale on the right axis. 

