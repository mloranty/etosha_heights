<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.6.42">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">


<title>Etosha Heights Random Forest Vegetation Summaries</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
</style>


<script src="eh_rf_summaries_files/libs/clipboard/clipboard.min.js"></script>
<script src="eh_rf_summaries_files/libs/quarto-html/quarto.js"></script>
<script src="eh_rf_summaries_files/libs/quarto-html/popper.min.js"></script>
<script src="eh_rf_summaries_files/libs/quarto-html/tippy.umd.min.js"></script>
<script src="eh_rf_summaries_files/libs/quarto-html/anchor.min.js"></script>
<link href="eh_rf_summaries_files/libs/quarto-html/tippy.css" rel="stylesheet">
<link href="eh_rf_summaries_files/libs/quarto-html/quarto-syntax-highlighting-2f5df379a58b258e96c21c0638c20c03.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="eh_rf_summaries_files/libs/bootstrap/bootstrap.min.js"></script>
<link href="eh_rf_summaries_files/libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="eh_rf_summaries_files/libs/bootstrap/bootstrap-1bc8a17f135ab3d594c857e9f48e611b.min.css" rel="stylesheet" append-hash="true" id="quarto-bootstrap" data-mode="light">


</head>

<body class="fullcontent">

<div id="quarto-content" class="page-columns page-rows-contents page-layout-article">

<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title">Etosha Heights Random Forest Vegetation Summaries</h1>
</div>



<div class="quarto-title-meta">

    
  
    
  </div>
  


</header>


<section id="overview" class="level2">
<h2 class="anchored" data-anchor-id="overview">Overview</h2>
<p>The following tables summarize a series of random forest models to predict vegetation communities across the Etosha Heights Private Reserve. The overarching idea is that seasonal timeseries of satellite observations are better suited to mapping fine-scale vegetation communities than a single image because the vegetation communities will respond differently to seasonal variation in precipitation and other environmental drivers. The following analyses utilize a stack of 25 Planet SuperDove images spanning the period from August 2023 to July 2024. Each image includes 8 spectral bands at 3 meter spatial resolution.</p>
</section>
<section id="predicting-vegetation-communities-with-ndvi" class="level2">
<h2 class="anchored" data-anchor-id="predicting-vegetation-communities-with-ndvi">Predicting Vegetation Communities with NDVI</h2>
<p>To begin, we’ll predict all 13 vegetation community classes using NDVI since that is the metric that captures the greatest degree of variability between the different vegetation communities across the growing season. The table below clearly indicates that prediction accuracy increases with the number of NDVI images. Using the full stack of 25 images yields approximately 75% accuracy (note the Kappa is a similar metric that takes into account the likelihood of achieving an accurate prediction due to chance).</p>
<div class="cell">
<div id="tbl-LABEL-1" class="cell quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-tbl figure">
<figcaption class="quarto-float-caption-top quarto-float-caption quarto-float-tbl" id="tbl-LABEL-1-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Table&nbsp;1: Accuracy and Kappa statistics for Random Forest models predicted using varying numbers of NDVI images. n indicates the number of images used for predictions. Images were selected as evenly spaced sequences from the entire seasonal time series.
</figcaption>
<div aria-describedby="tbl-LABEL-1-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<div class="cell-output-display">
<table class="do-not-create-environment cell caption-top table table-sm table-striped small">
<thead>
<tr class="header">
<th style="text-align: center;">Accuracy</th>
<th style="text-align: center;">Kappa</th>
<th style="text-align: center;">n</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: center;">0.7506702</td>
<td style="text-align: center;">0.7163359</td>
<td style="text-align: center;">25</td>
</tr>
<tr class="even">
<td style="text-align: center;">0.6769437</td>
<td style="text-align: center;">0.6316600</td>
<td style="text-align: center;">13</td>
</tr>
<tr class="odd">
<td style="text-align: center;">0.6112601</td>
<td style="text-align: center;">0.5579729</td>
<td style="text-align: center;">9</td>
</tr>
<tr class="even">
<td style="text-align: center;">0.5536193</td>
<td style="text-align: center;">0.4920064</td>
<td style="text-align: center;">7</td>
</tr>
<tr class="odd">
<td style="text-align: center;">0.4316354</td>
<td style="text-align: center;">0.3563273</td>
<td style="text-align: center;">5</td>
</tr>
<tr class="even">
<td style="text-align: center;">0.4865952</td>
<td style="text-align: center;">0.4186970</td>
<td style="text-align: center;">5</td>
</tr>
<tr class="odd">
<td style="text-align: center;">0.4061662</td>
<td style="text-align: center;">0.3297571</td>
<td style="text-align: center;">4</td>
</tr>
<tr class="even">
<td style="text-align: center;">0.3699732</td>
<td style="text-align: center;">0.2838907</td>
<td style="text-align: center;">4</td>
</tr>
<tr class="odd">
<td style="text-align: center;">0.3016086</td>
<td style="text-align: center;">0.2145559</td>
<td style="text-align: center;">3</td>
</tr>
<tr class="even">
<td style="text-align: center;">0.2801609</td>
<td style="text-align: center;">0.1901861</td>
<td style="text-align: center;">3</td>
</tr>
<tr class="odd">
<td style="text-align: center;">0.2815013</td>
<td style="text-align: center;">0.1932255</td>
<td style="text-align: center;">3</td>
</tr>
<tr class="even">
<td style="text-align: center;">0.2908847</td>
<td style="text-align: center;">0.1982764</td>
<td style="text-align: center;">3</td>
</tr>
</tbody>
</table>
</div>
</div>
</figure>
</div>
</div>
</section>
<section id="predicting-vegetation-communities-with-multispectral-images-from-a-single-date" class="level2">
<h2 class="anchored" data-anchor-id="predicting-vegetation-communities-with-multispectral-images-from-a-single-date">Predicting Vegetation Communities with Multispectral Images from a Single Date</h2>
<p>As a next step we can predict vegetation communities using individual 8-band multispectral images. We’ll do this for each of the 25 images in the time series to see if a particular seasonal timing yields better predictions. As the table below demonstrates, accuracy ranges from 53% to 67%, and while the higher accuracy generally occurs early in the rainy season during green-up, there is not an extremely strong seasonal trend. We can also compare this to the NDVI results above in Table 1, and note that using 8 multispectral bands from a single date yields prediction accuracy similar to 9 NDVI images distributed across the study period. This suggest that the number of predictor variables might be more important that capturing seasonal variability, or more specifically, the 8 multispectral bands from a single date capture as much spatial heterogeneity as a similar number of single-band NDVI images distributed across the annual cycle.</p>
<div class="cell">
<div id="tbl-LABEL-2" class="cell quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-tbl figure">
<figcaption class="quarto-float-caption-top quarto-float-caption quarto-float-tbl" id="tbl-LABEL-2-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Table&nbsp;2: Accuracy and Kappa statistics for Random Forest models predicted using individual multispectral images. file indicates the image date (yyyymmdd).
</figcaption>
<div aria-describedby="tbl-LABEL-2-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<div class="cell-output-display">
<table class="do-not-create-environment cell caption-top table table-sm table-striped small">
<thead>
<tr class="header">
<th style="text-align: center;">Accuracy</th>
<th style="text-align: center;">Kappa</th>
<th style="text-align: center;">file</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: center;">0.5563003</td>
<td style="text-align: center;">0.5003642</td>
<td style="text-align: center;">20230818</td>
</tr>
<tr class="even">
<td style="text-align: center;">0.6139410</td>
<td style="text-align: center;">0.5632700</td>
<td style="text-align: center;">20230930</td>
</tr>
<tr class="odd">
<td style="text-align: center;">0.6085791</td>
<td style="text-align: center;">0.5557495</td>
<td style="text-align: center;">20231102</td>
</tr>
<tr class="even">
<td style="text-align: center;">0.5683646</td>
<td style="text-align: center;">0.5125222</td>
<td style="text-align: center;">20231128</td>
</tr>
<tr class="odd">
<td style="text-align: center;">0.6742627</td>
<td style="text-align: center;">0.6314132</td>
<td style="text-align: center;">20231207</td>
</tr>
<tr class="even">
<td style="text-align: center;">0.5683646</td>
<td style="text-align: center;">0.5111223</td>
<td style="text-align: center;">20231213</td>
</tr>
<tr class="odd">
<td style="text-align: center;">0.6273458</td>
<td style="text-align: center;">0.5771432</td>
<td style="text-align: center;">20231220</td>
</tr>
<tr class="even">
<td style="text-align: center;">0.6434316</td>
<td style="text-align: center;">0.5959653</td>
<td style="text-align: center;">20231229</td>
</tr>
<tr class="odd">
<td style="text-align: center;">0.5911528</td>
<td style="text-align: center;">0.5398870</td>
<td style="text-align: center;">20240102</td>
</tr>
<tr class="even">
<td style="text-align: center;">0.5495979</td>
<td style="text-align: center;">0.4889400</td>
<td style="text-align: center;">20240112</td>
</tr>
<tr class="odd">
<td style="text-align: center;">0.5750670</td>
<td style="text-align: center;">0.5164996</td>
<td style="text-align: center;">20240118</td>
</tr>
<tr class="even">
<td style="text-align: center;">0.6126005</td>
<td style="text-align: center;">0.5625992</td>
<td style="text-align: center;">20240121</td>
</tr>
<tr class="odd">
<td style="text-align: center;">0.6032172</td>
<td style="text-align: center;">0.5547023</td>
<td style="text-align: center;">20240210</td>
</tr>
<tr class="even">
<td style="text-align: center;">0.5697051</td>
<td style="text-align: center;">0.5154060</td>
<td style="text-align: center;">20240216</td>
</tr>
<tr class="odd">
<td style="text-align: center;">0.5804290</td>
<td style="text-align: center;">0.5270304</td>
<td style="text-align: center;">20240302</td>
</tr>
<tr class="even">
<td style="text-align: center;">0.5764075</td>
<td style="text-align: center;">0.5198752</td>
<td style="text-align: center;">20240315</td>
</tr>
<tr class="odd">
<td style="text-align: center;">0.5576408</td>
<td style="text-align: center;">0.4986508</td>
<td style="text-align: center;">20240405</td>
</tr>
<tr class="even">
<td style="text-align: center;">0.5603217</td>
<td style="text-align: center;">0.5052020</td>
<td style="text-align: center;">20240410</td>
</tr>
<tr class="odd">
<td style="text-align: center;">0.5924933</td>
<td style="text-align: center;">0.5408738</td>
<td style="text-align: center;">20240418</td>
</tr>
<tr class="even">
<td style="text-align: center;">0.5924933</td>
<td style="text-align: center;">0.5403453</td>
<td style="text-align: center;">20240430</td>
</tr>
<tr class="odd">
<td style="text-align: center;">0.6058981</td>
<td style="text-align: center;">0.5543164</td>
<td style="text-align: center;">20240507</td>
</tr>
<tr class="even">
<td style="text-align: center;">0.6179625</td>
<td style="text-align: center;">0.5689732</td>
<td style="text-align: center;">20240519</td>
</tr>
<tr class="odd">
<td style="text-align: center;">0.5536193</td>
<td style="text-align: center;">0.4954433</td>
<td style="text-align: center;">20240530</td>
</tr>
<tr class="even">
<td style="text-align: center;">0.6112601</td>
<td style="text-align: center;">0.5604123</td>
<td style="text-align: center;">20240621</td>
</tr>
<tr class="odd">
<td style="text-align: center;">0.5321716</td>
<td style="text-align: center;">0.4707628</td>
<td style="text-align: center;">20240712</td>
</tr>
</tbody>
</table>
</div>
</div>
</figure>
</div>
</div>
</section>
<section id="predicting-vegetation-communities-with-multispectral-images-from-multiple-dates" class="level2">
<h2 class="anchored" data-anchor-id="predicting-vegetation-communities-with-multispectral-images-from-multiple-dates">Predicting Vegetation Communities with Multispectral Images from Multiple Dates</h2>
<p>To start we can predict land cover with an increasing number of multispectral images to examine how adding more data improves predictions. As the table below shows, accuracy increases as multiple images are used for prediction, however the magnitude of increase declines as successive images are added. For example going from one to two images increases accuracy by roughly 10%, whereas going from 5 to 6 predictor images (40 to 48 bands) only increases prediction accuracy by less than 1%. The overall accuracy of ~86% is quite good.</p>
<div class="cell">
<div id="tbl-LABEL-3" class="cell quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-tbl figure">
<figcaption class="quarto-float-caption-top quarto-float-caption quarto-float-tbl" id="tbl-LABEL-3-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Table&nbsp;3: Accuracy and Kappa statistics for Random Forest models predicted using multiple multispectral images. n indicates the number of multispectral bands used for the prediction. Since each images has 8 bands, n/8 is equal to the number of images. For this analysis we use the top 6 images from Table 2 above in descending order (i.e.&nbsp;n = 8 used the most accurate image, n = 16 used the two most accurate images, etc…)
</figcaption>
<div aria-describedby="tbl-LABEL-3-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<div class="cell-output-display">
<table class="do-not-create-environment cell caption-top table table-sm table-striped small">
<thead>
<tr class="header">
<th style="text-align: center;">Accuracy</th>
<th style="text-align: center;">Kappa</th>
<th style="text-align: center;">n</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: center;">0.6742627</td>
<td style="text-align: center;">0.6314132</td>
<td style="text-align: center;">8</td>
</tr>
<tr class="even">
<td style="text-align: center;">0.7721180</td>
<td style="text-align: center;">0.7413863</td>
<td style="text-align: center;">16</td>
</tr>
<tr class="odd">
<td style="text-align: center;">0.8150134</td>
<td style="text-align: center;">0.7908628</td>
<td style="text-align: center;">24</td>
</tr>
<tr class="even">
<td style="text-align: center;">0.8378016</td>
<td style="text-align: center;">0.8166786</td>
<td style="text-align: center;">32</td>
</tr>
<tr class="odd">
<td style="text-align: center;">0.8632708</td>
<td style="text-align: center;">0.8454219</td>
<td style="text-align: center;">40</td>
</tr>
<tr class="even">
<td style="text-align: center;">0.8713137</td>
<td style="text-align: center;">0.8545614</td>
<td style="text-align: center;">48</td>
</tr>
</tbody>
</table>
</div>
</div>
</figure>
</div>
</div>
<p>As a lest step we can examine accuracy with 5 multispectral images that are randomly selected from our timeseries stack (as opposed to selecting the five best individual images). This will be a useful way of knowing whether we can simply use any five images, or if the timing somehow matters.</p>
<div class="cell">
<div id="tbl-LABEL-4" class="cell quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-tbl figure">
<figcaption class="quarto-float-caption-top quarto-float-caption quarto-float-tbl" id="tbl-LABEL-4-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Table&nbsp;4: Accuracy and Kappa statistics for Random Forest models predicted using 5 multispectral images selected at Random. n indicates the number of multispectral bands used for the prediction. Since each images has 8 bands, n/8 is equal to the number of images.
</figcaption>
<div aria-describedby="tbl-LABEL-4-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<div class="cell-output-display">
<table class="do-not-create-environment cell caption-top table table-sm table-striped small">
<thead>
<tr class="header">
<th style="text-align: center;">Accuracy</th>
<th style="text-align: center;">Kappa</th>
<th style="text-align: center;">n</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: center;">0.8445040</td>
<td style="text-align: center;">0.8241481</td>
<td style="text-align: center;">40</td>
</tr>
<tr class="even">
<td style="text-align: center;">0.8780161</td>
<td style="text-align: center;">0.8619805</td>
<td style="text-align: center;">40</td>
</tr>
<tr class="odd">
<td style="text-align: center;">0.8699732</td>
<td style="text-align: center;">0.8533624</td>
<td style="text-align: center;">40</td>
</tr>
<tr class="even">
<td style="text-align: center;">0.8123324</td>
<td style="text-align: center;">0.7868937</td>
<td style="text-align: center;">40</td>
</tr>
<tr class="odd">
<td style="text-align: center;">0.8190349</td>
<td style="text-align: center;">0.7949101</td>
<td style="text-align: center;">40</td>
</tr>
</tbody>
</table>
</div>
</div>
</figure>
</div>
</div>
</section>
<section id="summary" class="level2">
<h2 class="anchored" data-anchor-id="summary">Summary</h2>
<p>Overall these results are quite good. Our highest accuracy values are typical to those observed for broad land cover classification tasks that often include classes that are much more distinct that the savanna vegetation communities that we’re predicting here. The pragmatic utility of our analysis is that it provides some guidelines for managers and researchers wanting to make fine-scale habitat maps. The results indicate that with five random images you can make a vegetation community/habitat map that is quite good. This seems like a good hook for this paper in my view. I might do a bit more tinkering to see if precipitation timing impacts model accuracy for the individual images, but on the whole this seems like a good near-final endpoint.</p>
</section>

</main>
<!-- /main column -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const onCopySuccess = function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  }
  const getTextToCopy = function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
    text: getTextToCopy
  });
  clipboard.on('success', onCopySuccess);
  if (window.document.getElementById('quarto-embedded-source-code-modal')) {
    const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
      text: getTextToCopy,
      container: window.document.getElementById('quarto-embedded-source-code-modal')
    });
    clipboardModal.on('success', onCopySuccess);
  }
    var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
    var mailtoRegex = new RegExp(/^mailto:/);
      var filterRegex = new RegExp('/' + window.location.host + '/');
    var isInternal = (href) => {
        return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
    }
    // Inspect non-navigation links and adorn them if external
 	var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
    for (var i=0; i<links.length; i++) {
      const link = links[i];
      if (!isInternal(link.href)) {
        // undo the damage that might have been done by quarto-nav.js in the case of
        // links that we want to consider external
        if (link.dataset.originalHref !== undefined) {
          link.href = link.dataset.originalHref;
        }
      }
    }
  function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
    const config = {
      allowHTML: true,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start',
    };
    if (contentFn) {
      config.content = contentFn;
    }
    if (onTriggerFn) {
      config.onTrigger = onTriggerFn;
    }
    if (onUntriggerFn) {
      config.onUntrigger = onUntriggerFn;
    }
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      if (note) {
        return note.innerHTML;
      } else {
        return "";
      }
    });
  }
  const xrefs = window.document.querySelectorAll('a.quarto-xref');
  const processXRef = (id, note) => {
    // Strip column container classes
    const stripColumnClz = (el) => {
      el.classList.remove("page-full", "page-columns");
      if (el.children) {
        for (const child of el.children) {
          stripColumnClz(child);
        }
      }
    }
    stripColumnClz(note)
    if (id === null || id.startsWith('sec-')) {
      // Special case sections, only their first couple elements
      const container = document.createElement("div");
      if (note.children && note.children.length > 2) {
        container.appendChild(note.children[0].cloneNode(true));
        for (let i = 1; i < note.children.length; i++) {
          const child = note.children[i];
          if (child.tagName === "P" && child.innerText === "") {
            continue;
          } else {
            container.appendChild(child.cloneNode(true));
            break;
          }
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(container);
        }
        return container.innerHTML
      } else {
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        return note.innerHTML;
      }
    } else {
      // Remove any anchor links if they are present
      const anchorLink = note.querySelector('a.anchorjs-link');
      if (anchorLink) {
        anchorLink.remove();
      }
      if (window.Quarto?.typesetMath) {
        window.Quarto.typesetMath(note);
      }
      if (note.classList.contains("callout")) {
        return note.outerHTML;
      } else {
        return note.innerHTML;
      }
    }
  }
  for (var i=0; i<xrefs.length; i++) {
    const xref = xrefs[i];
    tippyHover(xref, undefined, function(instance) {
      instance.disable();
      let url = xref.getAttribute('href');
      let hash = undefined; 
      if (url.startsWith('#')) {
        hash = url;
      } else {
        try { hash = new URL(url).hash; } catch {}
      }
      if (hash) {
        const id = hash.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note !== null) {
          try {
            const html = processXRef(id, note.cloneNode(true));
            instance.setContent(html);
          } finally {
            instance.enable();
            instance.show();
          }
        } else {
          // See if we can fetch this
          fetch(url.split('#')[0])
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.getElementById(id);
            if (note !== null) {
              const html = processXRef(id, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      } else {
        // See if we can fetch a full url (with no hash to target)
        // This is a special case and we should probably do some content thinning / targeting
        fetch(url)
        .then(res => res.text())
        .then(html => {
          const parser = new DOMParser();
          const htmlDoc = parser.parseFromString(html, "text/html");
          const note = htmlDoc.querySelector('main.content');
          if (note !== null) {
            // This should only happen for chapter cross references
            // (since there is no id in the URL)
            // remove the first header
            if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
              note.children[0].remove();
            }
            const html = processXRef(null, note);
            instance.setContent(html);
          } 
        }).finally(() => {
          instance.enable();
          instance.show();
        });
      }
    }, function(instance) {
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            div.style.left = 0;
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
        // Handle positioning of the toggle
    window.addEventListener(
      "resize",
      throttle(() => {
        elRect = undefined;
        if (selectedAnnoteEl) {
          selectCodeLines(selectedAnnoteEl);
        }
      }, 10)
    );
    function throttle(fn, ms) {
    let throttle = false;
    let timer;
      return (...args) => {
        if(!throttle) { // first call gets through
            fn.apply(this, args);
            throttle = true;
        } else { // all the others get throttled
            if(timer) clearTimeout(timer); // cancel #2
            timer = setTimeout(() => {
              fn.apply(this, args);
              timer = throttle = false;
            }, ms);
        }
      };
    }
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
</div> <!-- /content -->




</body></html>